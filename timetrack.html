!DOCTYPE html
html lang=en
head
    meta charset=UTF-8
    meta name=viewport content=width=device-width, initial-scale=1.0
    titleTime Tracker & Reportertitle
    script src=httpscdn.tailwindcss.comscript
    link href=httpsfonts.googleapis.comcss2family=Interwght@400;600;700&display=swap rel=stylesheet
    !-- Font Awesome for icons --
    link rel=stylesheet href=httpscdnjs.cloudflare.comajaxlibsfont-awesome6.0.0-beta3cssall.min.css
    style
        body {
            font-family 'Inter', sans-serif;
            background-color #1a1a1a;  Dark background 
            color #e0e0e0;  Light text color 
        }
        .container {
            max-width 95%;  Wider fluid width 
            margin 2rem auto;
            padding 1.5rem;
            background-color #2a2a2a;  Darker container background 
            border-radius 1rem;
            box-shadow 0 10px 30px -5px rgba(0, 0, 0, 0.3), 0 8px 12px -6px rgba(0, 0, 0, 0.2);
        }
        .top-bar {
            background-color #3a3a3a;
            padding 1rem;
            border-radius 0.75rem;
            display flex;
            align-items center;
            gap 1rem;
            margin-bottom 1.5rem;
            flex-wrap wrap;  Allow items to wrap on smaller screens 
        }
        .top-bar input, .top-bar select {
            background-color #4a4a4a;
            border 1px solid #555;
            color #e0e0e0;
            padding 0.75rem 1rem;
            border-radius 0.5rem;
            flex-grow 1;
        }
        .top-bar inputplaceholder, .top-bar select option {
            color #b0b0b0;
        }
        .timer-display {
            font-family 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size 2.25rem;  Larger timer 
            font-weight 600;
            color #e0e0e0;
            min-width 150px;
            text-align right;
            flex-shrink 0;  Prevent timer from shrinking 
        }
        .play-pause-btn {
            background-color #6a0dad;  Purple accent 
            color white;
            width 48px;
            height 48px;
            border-radius 50%;
            display flex;
            align-items center;
            justify-content center;
            font-size 1.5rem;
            transition background-color 0.3s ease, transform 0.2s ease;
            box-shadow 0 4px 10px rgba(106, 13, 173, 0.4);
            flex-shrink 0;  Prevent button from shrinking 
        }
        .play-pause-btnhover {
            background-color #8a2be2;
            transform scale(1.05);
        }
        .icon-btn {
            color #b0b0b0;
            font-size 1.25rem;
            transition color 0.2s ease;
        }
        .icon-btnhover {
            color #e0e0e0;
        }
        .date-nav {
            background-color #3a3a3a;
            padding 0.75rem 1rem;
            border-radius 0.75rem;
            display flex;
            align-items center;
            justify-content space-between;
            margin-bottom 1.5rem;
            color #e0e0e0;
            font-weight 600;
        }
        .date-nav button {
            background none;
            border none;
            color #b0b0b0;
            font-size 1.25rem;
            cursor pointer;
            padding 0.5rem;
            border-radius 0.5rem;
            transition background-color 0.2s ease, color 0.2s ease;
        }
        .date-nav buttonhover {
            background-color #4a4a4a;
            color #e0e0e0;
        }
        .total-display {
            font-size 1.1rem;
            font-weight 500;
            color #c0c0c0;
        }
        .main-content {
            display grid;
            grid-template-columns 2fr 1fr;  Task list on left, goalsprojects on right 
            gap 1.5rem;
        }
        @media (max-width 1024px) {
            .main-content {
                grid-template-columns 1fr;  Stack on smaller screens 
            }
        }
        .section-card {
            background-color #3a3a3a;
            padding 1.5rem;
            border-radius 0.75rem;
            box-shadow 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .section-card h2 {
            font-size 1.75rem;
            font-weight 700;
            color #e0e0e0;
            margin-bottom 1rem;
        }
        .task-entry {
            background-color #4a4a4a;
            padding 1rem 1.25rem;
            border-radius 0.75rem;
            margin-bottom 0.75rem;
            display flex;
            align-items center;
            justify-content space-between;
            color #e0e0e0;
            box-shadow 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .task-entry-details {
            flex-grow 1;
        }
        .task-entry-description {
            font-weight 600;
            font-size 1.1rem;
            margin-bottom 0.25rem;
        }
        .task-entry-times {
            font-size 0.9rem;
            color #b0b0b0;
        }
        .task-entry-duration {
            font-family 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-weight 600;
            font-size 1.1rem;
            color #6EE7B7;  Changed to vibrant light green for better visibility 
        }
        .goal-item, .project-item {
            background-color #4a4a4a;
            padding 1rem;
            border-radius 0.75rem;
            margin-bottom 0.75rem;
            display flex;
            align-items center;
            gap 1rem;
            color #e0e0e0;
            box-shadow 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .goal-progress-circle {
            position relative;
            width 50px;
            height 50px;
            border-radius 50%;
            background conic-gradient(#6a0dad var(--progress, 0%), #555 0%);
            display flex;
            align-items center;
            justify-content center;
            font-size 0.8rem;
            font-weight 600;
            color white;
        }
        .goal-progress-circlebefore {
            content '';
            position absolute;
            width 40px;
            height 40px;
            border-radius 50%;
            background-color #4a4a4a;
        }
        .goal-progress-circle span {
            position relative;
            z-index 1;
        }
        .add-goal-input-group {
            display flex;
            gap 0.5rem;
            margin-top 1rem;
        }
        .add-goal-input-group input {
            flex-grow 1;
            background-color #4a4a4a;
            border 1px solid #555;
            color #e0e0e0;
            padding 0.75rem;
            border-radius 0.5rem;
        }
        .add-goal-input-group button {
            background-color #6a0dad;
            color white;
            padding 0.75rem 1rem;
            border-radius 0.5rem;
            transition background-color 0.3s ease;
        }
        .add-goal-input-group buttonhover {
            background-color #8a2be2;
        }

         Custom Modal 
        #customModal, #createGoalModal, #createProjectModal, #advancedReportModal, #editTimeEntryModal, #editGoalModal, #editProjectModal, #exportDataModal {
            background-color rgba(0, 0, 0, 0.7);  Darker overlay 
        }
        #customModal  div {
            background-color #3a3a3a;  Dark modal background 
            color #e0e0e0;
            border-radius 1rem;
            box-shadow 0 10px 30px rgba(0, 0, 0, 0.5);
            padding 1.5rem;
            max-width 500px;  Max width for general alerts 
            width 90%;  Fluid width 
        }
        #createGoalModal  div, #createProjectModal  div, #editTimeEntryModal  div, #editGoalModal  div, #editProjectModal  div {  Specific styles for modals 
            background-color #3a3a3a;  Dark modal background 
            color #e0e0e0;
            border-radius 1rem;
            box-shadow 0 10px 30px rgba(0, 0, 0, 0.5);
            padding 1rem;  Reduced padding 
            max-width 350px;  Further reduced max-width 
            width 90%;  Fluid width 
            max-height 80vh;  Max height for scrollability 
            overflow-y auto;  Enable vertical scrolling 
        }
        #advancedReportModal  div, #exportDataModal  div {  Specific styles for advanced report modal and export modal 
            background-color #3a3a3a;
            color #e0e0e0;
            border-radius 1rem;
            box-shadow 0 10px 30px rgba(0, 0, 0, 0.5);
            padding 1.5rem;
            max-width 600px;  Wider for reports and export 
            width 90%;
            max-height 90vh;  Allow more height for results 
            overflow-y auto;
        }
        #modalMessage {
            color #e0e0e0;
        }
        #modalButtons button, #createGoalModal button, #createProjectModal button, #advancedReportModal button, #editTimeEntryModal button, #editGoalModal button, #editProjectModal button, #exportDataModal button {
            @apply py-2 px-4 rounded-lg font-bold transition duration-300 ease-in-out;
        }
        #modalConfirmBtn, #modalCloseBtn, #createGoalBtnModal, #createProjectBtnModal, #generateReportBtn, #saveTimeEntryBtn, #saveGoalEditBtn, #saveProjectEditBtn, #exportDataConfirmBtn {
            @apply bg-purple-600 hoverbg-purple-700 text-white;
        }
        #modalCancelBtn, #cancelGoalBtn, #cancelProjectBtn, #closeReportModalBtn, #cancelTimeEntryEditBtn, #cancelGoalEditBtn, #cancelProjectEditBtn, #cancelExportBtn {
            @apply bg-gray-600 hoverbg-gray-700 text-white;
        }
        .form-group {
            margin-bottom 1rem;
        }
        .form-group label {
            display block;
            margin-bottom 0.5rem;
            font-weight 600;
            color #c0c0c0;
        }
        .form-group input[type=text],
        .form-group input[type=number],
        .form-group input[type=date],
        .form-group select {
            background-color #4a4a4a;
            border 1px solid #555;
            color #e0e0e0;
            padding 0.75rem;
            border-radius 0.5rem;
            width 100%;
            box-sizing border-box;
        }
        .form-group input[type=text]placeholder,
        .form-group input[type=number]placeholder {
            color #b0b0b0;
        }
        .form-group select option {
            background-color #4a4a4a;
            color #e0e0e0;
        }
        .form-group input[type=checkbox], .form-group input[type=radio] {
            margin-right 0.5rem;
        }
        .modal-header {
            display flex;
            justify-content space-between;
            align-items center;
            margin-bottom 1.5rem;
            flex-shrink 0;  Prevent header from shrinking 
        }
        .modal-header h3 {
            font-size 1.5rem;
            font-weight 700;
            color #e0e0e0;
        }
        .modal-close-btn {
            background none;
            border none;
            color #b0b0b0;
            font-size 1.5rem;
            cursor pointer;
        }
        .modal-close-btnhover {
            color #e0e0e0;
        }

         Scrollable content areas 
        .scrollable-content {
            max-height 400px;  Adjust as needed 
            overflow-y auto;
            padding-right 0.5rem;  Space for scrollbar 
        }
         Custom scrollbar for dark theme 
        .scrollable-content-webkit-scrollbar,
        #createGoalModal  div-webkit-scrollbar,
        #createProjectModal  div-webkit-scrollbar,
        #advancedReportModal  div-webkit-scrollbar,
        #editTimeEntryModal  div-webkit-scrollbar,
        #editGoalModal  div-webkit-scrollbar,
        #editProjectModal  div-webkit-scrollbar,
        #exportDataModal  div-webkit-scrollbar {  Apply to modal content too 
            width 8px;
        }
        .scrollable-content-webkit-scrollbar-track,
        #createGoalModal  div-webkit-scrollbar-track,
        #createProjectModal  div-webkit-scrollbar-track,
        #advancedReportModal  div-webkit-scrollbar-track,
        #editTimeEntryModal  div-webkit-scrollbar-track,
        #editGoalModal  div-webkit-scrollbar-track,
        #editProjectModal  div-webkit-scrollbar-track,
        #exportDataModal  div-webkit-scrollbar-track {
            background #3a3a3a;
            border-radius 10px;
        }
        .scrollable-content-webkit-scrollbar-thumb,
        #createGoalModal  div-webkit-scrollbar-thumb,
        #createProjectModal  div-webkit-scrollbar-thumb,
        #advancedReportModal  div-webkit-scrollbar-thumb,
        #editTimeEntryModal  div-webkit-scrollbar-thumb,
        #editGoalModal  div-webkit-scrollbar-thumb,
        #editProjectModal  div-webkit-scrollbar-thumb,
        #exportDataModal  div-webkit-scrollbar-thumb {
            background #555;
            border-radius 10px;
        }
        .scrollable-content-webkit-scrollbar-thumbhover,
        #createGoalModal  div-webkit-scrollbar-thumbhover,
        #createProjectModal  div-webkit-scrollbar-thumbhover,
        #advancedReportModal  div-webkit-scrollbar-thumbhover,
        #editTimeEntryModal  div-webkit-scrollbar-thumbhover,
        #editGoalModal  div-webkit-scrollbar-thumbhover,
        #editProjectModal  div-webkit-scrollbar-thumbhover,
        #exportDataModal  div-webkit-scrollbar-thumbhover {
            background #777;
        }

        .report-entry {
            background-color #4a4a4a;
            padding 0.75rem 1rem;
            border-radius 0.5rem;
            margin-bottom 0.5rem;
            display flex;
            flex-direction column;
            color #e0e0e0;
        }
        .report-entry-header {
            display flex;
            justify-content space-between;
            font-weight 600;
            margin-bottom 0.25rem;
        }
        .report-entry-details {
            font-size 0.85rem;
            color #b0b0b0;
        }

         Toast Notification 
        .toast-notification {
            position fixed;
            bottom 20px;
            left 50%;
            transform translateX(-50%);
            background-color #4CAF50;  Green for success 
            color white;
            padding 12px 20px;
            border-radius 8px;
            box-shadow 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index 1000;
            opacity 0;
            transition opacity 0.5s ease-in-out;
        }
        .toast-notification.show {
            opacity 1;
        }
        .toast-notification.error {
            background-color #f44336;  Red for error 
        }


         Responsive adjustments 
        @media (max-width 768px) {
            .container {
                margin 1rem auto;
                padding 1rem;
            }
            .top-bar {
                flex-direction column;
                align-items stretch;
            }
            .top-bar   {
                margin-bottom 0.5rem;
            }
            .timer-display {
                text-align center;
                font-size 2rem;
            }
            .date-nav {
                flex-wrap wrap;
                justify-content center;
            }
            .date-nav  div {
                flex-basis 100%;
                text-align center;
                margin-bottom 0.5rem;
            }
            .date-nav button {
                margin 0 0.5rem;
            }
            .main-content {
                grid-template-columns 1fr;
            }
            #createGoalModal  div, #createProjectModal  div, #advancedReportModal  div, #editTimeEntryModal  div, #editGoalModal  div, #editProjectModal  div, #exportDataModal  div {
                padding 1rem;
            }
        }
    style
head
body class=antialiased
    div class=container
        !-- Top Bar Project Selection  Task Input  Timer  Play-Pause --
        div class=top-bar
            select id=projectSelect class=w-full mdw-14 aria-label=Select Project
                option value=Select Project (Optional)option
                !-- Projects will be dynamically loaded here --
            select
            input type=text id=taskInput placeholder=What are you working on class=w-full mdw-12 aria-label=Task Description
            span id=timerDisplay class=timer-display00000span
            button id=playPauseButton class=play-pause-btn aria-label=Start or Pause Timer
                i id=playPauseIcon class=fas fa-playi
            button
        div

        !-- Date Navigation and Totals --
        div class=date-nav
            button id=prevDateBtn aria-label=Previous Dayi class=fas fa-chevron-leftibutton
            div class=flex items-center gap-2
                button id=goToTodayBtn class=bg-transparent hoverbg-gray-700 text-gray-400 hovertext-white p-1 rounded-full aria-label=Go to Today's Tasksi class=fas fa-calendar-altibutton
                span id=currentViewDateDisplayspan
            div
            button id=nextDateBtn aria-label=Next Dayi class=fas fa-chevron-rightibutton
            div class=total-displayTODAY TOTAL span id=todayTotalDisplay00000spandiv
            div class=total-displayWEEK TOTAL span id=weekTotalDisplay00000spandiv
        div

        !-- Main Content Task List, Goals, and Projects --
        div class=main-content
            !-- Task List Section --
            div class=section-card
                h2 class=text-purple-400Tasks for span id=currentViewDateDisplayHeaderTodayspanh2
                div id=taskList class=mt-4 scrollable-content
                    !-- Task entries will be dynamically added here --
                    p id=noEntriesMessage class=text-gray-400 text-center py-4No entries for this day. Start tracking!p
                div
            div

            !-- Right Column Goals and Projects --
            div class=flex flex-col space-y-4
                !-- Goals Section --
                div class=section-card flex-grow
                    h2 class=text-purple-400Goals button id=openCreateGoalModalBtn class=ml-2 text-gray-400 hovertext-white aria-label=Create New Goali class=fas fa-plus-circleibuttonh2
                    div id=goalsList class=mt-4 scrollable-content
                        !-- Goals will be dynamically added here --
                        p id=noGoalsMessage class=text-gray-400 text-center py-4No goals set yet.p
                    div
                div

                !-- Projects Section --
                div class=section-card flex-grow
                    h2 class=text-purple-400Projects button id=openCreateProjectModalBtn class=ml-2 text-gray-400 hovertext-white aria-label=Create New Projecti class=fas fa-plus-circleibuttonh2
                    div id=projectsList class=mt-4 scrollable-content
                        !-- Projects will be dynamically added here --
                        p id=noProjectsMessage class=text-gray-400 text-center py-4No projects yet. Create one!p
                    div
                div

                !-- Reports and Export Buttons --
                div class=section-card flex-grow flex flex-col items-center justify-center space-y-4
                    button id=openAdvancedReportModalBtn class=bg-purple-600 hoverbg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hoverscale-105 flex items-center gap-2 w-full justify-center aria-label=Open Advanced Reports
                        i class=fas fa-chart-bari Advanced Reports
                    button
                    button id=openExportDataModalBtn class=bg-gray-600 hoverbg-gray-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hoverscale-105 flex items-center gap-2 w-full justify-center aria-label=Open Export Data Options
                        i class=fas fa-downloadi Export Data
                    button
                div
            div
        div
    div

    !-- Custom Modal for AlertsConfirmations --
    div id=customModal class=fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50
        div class=bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center
            p id=modalMessage class=text-lg font-semibold text-gray-800 mb-4p
            div id=modalButtons class=flex justify-center space-x-4
                button id=modalConfirmBtn class=btn-primary hidden aria-label=ConfirmConfirmbutton
                button id=modalCancelBtn class=btn-secondary hidden aria-label=CancelCancelbutton
                button id=modalCloseBtn class=btn-primary aria-label=OKOKbutton
            div
        div
    div

    !-- Create Goal Modal --
    div id=createGoalModal class=fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50
        div class=bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full role=dialog aria-modal=true aria-labelledby=createGoalModalTitle
            div class=modal-header
                h3 id=createGoalModalTitleCreate a goalh3
                button id=closeCreateGoalModalBtn class=modal-close-btn aria-label=Close Create Goal Modali class=fas fa-timesibutton
            div

            div class=form-group
                label for=goalNameInputGOALlabel
                input type=text id=goalNameInput placeholder=Goal name aria-required=true
                p id=goalNameError class=text-red-400 text-sm mt-1 hiddenGoal name cannot be empty.p
            div

            div class=form-group
                label for=memberSelectMEMBERlabel
                select id=memberSelect disabled aria-label=Member Selection
                    option value=youNajmussalahin Adib (You)option
                select
            div

            div class=form-group
                label for=goalProjectSelectTRACK (Project) i class=fas fa-info-circle text-gray-400 ml-1ilabel
                select id=goalProjectSelect aria-label=Track Project
                    option value=Select Project (Optional)option
                    !-- Projects will be dynamically loaded here --
                select
            div

            div class=form-group
                labelFOR i class=fas fa-info-circle text-gray-400 ml-1ilabel
                div class=flex space-x-2
                    select id=forTypeSelect class=w-13 aria-label=Goal Type
                        option value=atLeastat leastoption
                        !-- Other options like exactly, at most could be added --
                    select
                    input type=number id=forHoursInput placeholder=hours class=w-13 min=0.1 step=0.1 aria-required=true aria-label=Target Hours
                    select id=forFrequencySelect class=w-13 aria-label=Goal Frequency
                        option value=dayevery dayoption
                        option value=weekevery weekoption
                        option value=monthevery monthoption
                    select
                div
                p id=forHoursError class=text-red-400 text-sm mt-1 hiddenPlease enter a valid positive number for hours.p
            div

            div class=form-group
                label for=untilDateInputUNTIL i class=fas fa-info-circle text-gray-400 ml-1ilabel
                input type=date id=untilDateInput aria-label=End Date
                div class=mt-2
                    input type=checkbox id=noEndDateCheckbox aria-label=No End Date
                    label for=noEndDateCheckboxNo end datelabel
                div
                p id=untilDateError class=text-red-400 text-sm mt-1 hiddenPlease select an end date or check 'No end date'.p
            div

            div class=flex justify-end space-x-4 mt-6
                button id=cancelGoalBtn class=btn-secondary aria-label=Cancel Goal CreationCancelbutton
                button id=createGoalBtnModal class=btn-primary aria-label=Create GoalCreate goalbutton
            div
        div
    div

    !-- Create Project Modal --
    div id=createProjectModal class=fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50
        div class=bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full role=dialog aria-modal=true aria-labelledby=createProjectModalTitle
            div class=modal-header
                h3 id=createProjectModalTitleCreate a new projecth3
                button id=closeCreateProjectModalBtn class=modal-close-btn aria-label=Close Create Project Modali class=fas fa-timesibutton
            div

            div class=form-group
                label for=projectNameInputProject Namelabel
                input type=text id=projectNameInput placeholder=e.g., Website Redesign aria-required=true
                p id=projectNameError class=text-red-400 text-sm mt-1 hiddenProject name cannot be empty.p
            div

            div class=flex justify-end space-x-4 mt-6
                button id=cancelProjectBtn class=btn-secondary aria-label=Cancel Project CreationCancelbutton
                button id=createProjectBtnModal class=btn-primary aria-label=Create ProjectCreate Projectbutton
            div
        div
    div

    !-- Advanced Report Modal --
    div id=advancedReportModal class=fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50
        div class=bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full role=dialog aria-modal=true aria-labelledby=advancedReportModalTitle
            div class=modal-header
                h3 id=advancedReportModalTitleAdvanced Reportsh3
                button id=closeReportModalBtn class=modal-close-btn aria-label=Close Advanced Report Modali class=fas fa-timesibutton
            div

            div class=form-group
                label for=reportProjectSelectFilter by Projectlabel
                select id=reportProjectSelect aria-label=Report Project Filter
                    option value=All Projectsoption
                    !-- Projects will be dynamically loaded here --
                select
            div

            div class=form-group flex space-x-2
                div class=w-12
                    label for=reportStartDateInputStart Datelabel
                    input type=date id=reportStartDateInput aria-label=Report Start Date
                div
                div class=w-12
                    label for=reportEndDateInputEnd Datelabel
                    input type=date id=reportEndDateInput aria-label=Report End Date
                div
            div
            p id=reportDateError class=text-red-400 text-sm mt-1 hiddenStart date cannot be after end date.p


            div class=flex justify-end mt-4
                button id=generateReportBtn class=btn-primary aria-label=Generate ReportGenerate Reportbutton
            div

            div class=mt-6
                h4 class=text-lg font-semibold text-purple-400 mb-3Report Resultsh4
                div id=reportResultsList class=scrollable-content max-h-60
                    p class=text-gray-400 text-center py-4Generate a report to see results here.p
                div
                div class=text-right font-bold text-lg mt-4
                    Total Report Time span id=reportTotalDisplay class=text-purple-40000000span
                div
            div
        div
    div

    !-- Edit Time Entry Modal --
    div id=editTimeEntryModal class=fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50
        div class=bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full role=dialog aria-modal=true aria-labelledby=editTimeEntryModalTitle
            div class=modal-header
                h3 id=editTimeEntryModalTitleEdit Time Entryh3
                button id=closeTimeEntryEditModalBtn class=modal-close-btn aria-label=Close Edit Time Entry Modali class=fas fa-timesibutton
            div
            input type=hidden id=editTimeEntryId
            div class=form-group
                label for=editTaskInputTask Descriptionlabel
                input type=text id=editTaskInput aria-required=true
                p id=editTaskError class=text-red-400 text-sm mt-1 hiddenTask description cannot be empty.p
            div
            div class=form-group
                label for=editTimeEntryProjectSelectProjectlabel
                select id=editTimeEntryProjectSelect aria-label=Edit Time Entry Project
                    option value=Select Project (Optional)option
                    !-- Projects will be dynamically loaded here --
                select
            div
            div class=flex justify-end space-x-4 mt-6
                button id=cancelTimeEntryEditBtn class=btn-secondary aria-label=Cancel Time Entry EditCancelbutton
                button id=saveTimeEntryBtn class=btn-primary aria-label=Save Time Entry ChangesSave Changesbutton
            div
        div
    div

    !-- Edit Goal Modal --
    div id=editGoalModal class=fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50
        div class=bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full role=dialog aria-modal=true aria-labelledby=editGoalModalTitle
            div class=modal-header
                h3 id=editGoalModalTitleEdit Goalh3
                button id=closeGoalEditModalBtn class=modal-close-btn aria-label=Close Edit Goal Modali class=fas fa-timesibutton
            div
            input type=hidden id=editGoalId
            div class=form-group
                label for=editGoalNameInputGOALlabel
                input type=text id=editGoalNameInput aria-required=true
                p id=editGoalNameError class=text-red-400 text-sm mt-1 hiddenGoal name cannot be empty.p
            div
            div class=form-group
                label for=editGoalProjectSelectTRACK (Project)label
                select id=editGoalProjectSelect aria-label=Edit Goal Project
                    option value=Select Project (Optional)option
                    !-- Projects will be dynamically loaded here --
                select
            div
            div class=form-group
                labelFORlabel
                div class=flex space-x-2
                    select id=editForTypeSelect class=w-13 aria-label=Edit Goal Type
                        option value=atLeastat leastoption
                    select
                    input type=number id=editForHoursInput placeholder=hours class=w-13 min=0.1 step=0.1 aria-required=true aria-label=Edit Target Hours
                    select id=editForFrequencySelect class=w-13 aria-label=Edit Goal Frequency
                        option value=dayevery dayoption
                        option value=weekevery weekoption
                        option value=monthevery monthoption
                    select
                div
                p id=editForHoursError class=text-red-400 text-sm mt-1 hiddenPlease enter a valid positive number for hours.p
            div
            div class=form-group
                label for=editUntilDateInputUNTILlabel
                input type=date id=editUntilDateInput aria-label=Edit End Date
                div class=mt-2
                    input type=checkbox id=editNoEndDateCheckbox aria-label=Edit No End Date
                    label for=editNoEndDateCheckboxNo end datelabel
                div
                p id=editUntilDateError class=text-red-400 text-sm mt-1 hiddenPlease select an end date or check 'No end date'.p
            div
            div class=flex justify-end space-x-4 mt-6
                button id=cancelGoalEditBtn class=btn-secondary aria-label=Cancel Goal EditCancelbutton
                button id=saveGoalEditBtn class=btn-primary aria-label=Save Goal ChangesSave Changesbutton
            div
        div
    div

    !-- Edit Project Modal --
    div id=editProjectModal class=fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50
        div class=bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full role=dialog aria-modal=true aria-labelledby=editProjectModalTitle
            div class=modal-header
                h3 id=editProjectModalTitleEdit Projecth3
                button id=closeProjectEditModalBtn class=modal-close-btn aria-label=Close Edit Project Modali class=fas fa-timesibutton
            div
            input type=hidden id=editProjectId
            div class=form-group
                label for=editProjectNameInputProject Namelabel
                input type=text id=editProjectNameInput aria-required=true
                p id=editProjectNameError class=text-red-400 text-sm mt-1 hiddenProject name cannot be empty.p
                p id=editProjectDuplicateError class=text-red-400 text-sm mt-1 hiddenA project with this name already exists.p
            div
            div class=flex justify-end space-x-4 mt-6
                button id=cancelProjectEditBtn class=btn-secondary aria-label=Cancel Project EditCancelbutton
                button id=saveProjectEditBtn class=btn-primary aria-label=Save Project ChangesSave Changesbutton
            div
        div
    div

    !-- Export Data Modal --
    div id=exportDataModal class=fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50
        div class=bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full role=dialog aria-modal=true aria-labelledby=exportDataModalTitle
            div class=modal-header
                h3 id=exportDataModalTitleExport Datah3
                button id=closeExportModalBtn class=modal-close-btn aria-label=Close Export Data Modali class=fas fa-timesibutton
            div

            div class=form-group
                labelSelect Data to Exportlabel
                div class=flex flex-col space-y-2
                    label class=inline-flex items-center
                        input type=radio name=exportDataType value=timeEntries checked aria-label=Export Time Entries
                        span class=ml-2Time Entriesspan
                    label
                    label class=inline-flex items-center
                        input type=radio name=exportDataType value=goals aria-label=Export Goals
                        span class=ml-2Goalsspan
                    label
                    label class=inline-flex items-center
                        input type=radio name=exportDataType value=projects aria-label=Export Projects
                        span class=ml-2Projectsspan
                    label
                div
            div

            div id=timeEntriesExportOptions class=form-group border border-gray-600 rounded-lg p-3
                labelTime Entries Export Scopelabel
                div class=flex flex-col space-y-2
                    label class=inline-flex items-center
                        input type=radio name=timeEntriesScope value=all checked aria-label=Export All Time Entries
                        span class=ml-2All Time Entriesspan
                    label
                    label class=inline-flex items-center
                        input type=radio name=timeEntriesScope value=filtered aria-label=Export Filtered Time Entries
                        span class=ml-2Filtered by Report Criteriaspan
                    label
                div
            div

            div class=form-group mt-4
                labelSelect Export Formatlabel
                div class=flex space-x-4
                    label class=inline-flex items-center
                        input type=radio name=exportFormat value=csv checked aria-label=Export as CSV
                        span class=ml-2CSVspan
                    label
                    label class=inline-flex items-center
                        input type=radio name=exportFormat value=json aria-label=Export as JSON
                        span class=ml-2JSONspan
                    label
                div
            div

            div class=flex justify-end space-x-4 mt-6
                button id=cancelExportBtn class=btn-secondary aria-label=Cancel ExportCancelbutton
                button id=exportDataConfirmBtn class=btn-primary aria-label=Confirm ExportExportbutton
            div
        div
    div

    !-- Toast Notification Container --
    div id=toastContainer class=fixed bottom-4 left-12 transform -translate-x-12 z-[1000]div


    script type=module
         UI Elements
        const projectSelect = document.getElementById('projectSelect');
        const taskInput = document.getElementById('taskInput');
        const playPauseButton = document.getElementById('playPauseButton');
        const playPauseIcon = document.getElementById('playPauseIcon');
        const timerDisplay = document.getElementById('timerDisplay');
        const todayTotalDisplay = document.getElementById('todayTotalDisplay');
        const weekTotalDisplay = document.getElementById('weekTotalDisplay');
        const taskList = document.getElementById('taskList');
        const noEntriesMessage = document.getElementById('noEntriesMessage');
        const goalsList = document.getElementById('goalsList');
        const noGoalsMessage = document.getElementById('noGoalsMessage');
        const openCreateGoalModalBtn = document.getElementById('openCreateGoalModalBtn');
        const projectsList = document.getElementById('projectsList');
        const noProjectsMessage = document.getElementById('noProjectsMessage');
        const openCreateProjectModalBtn = document.getElementById('openCreateProjectModalBtn');
        const openAdvancedReportModalBtn = document.getElementById('openAdvancedReportModalBtn');  New button
        const openExportDataModalBtn = document.getElementById('openExportDataModalBtn');  New button

         Date Navigation Elements
        const prevDateBtn = document.getElementById('prevDateBtn');
        const nextDateBtn = document.getElementById('nextDateBtn');
        const goToTodayBtn = document.getElementById('goToTodayBtn');
        const currentViewDateDisplay = document.getElementById('currentViewDateDisplay');  For Tasks for [Date]
        const currentViewDateDisplayHeader = document.getElementById('currentViewDateDisplayHeader');  For Tasks for [Date] in header

         Timer variables
        let timerInterval = null;
        let startTime = null;
        let currentTask = null;  Stores the current task object being tracked

         Date for displaying tasks (can be navigated)
        let currentDisplayedDate = new Date();  Date currently shown in the task list

         Data structures for local storage
        let timeEntries = [];  Array of { id, task, projectId, projectName, startTime, endTime, durationMs }
        let goals = [];        Array of { id, name, targetMs, frequency, endDate, currentMs, lastResetDate, projectId, projectName }
        let projects = [];     Array of { id, name }

         Custom Modal Elements (for alertsconfirmations)
        const customModal = document.getElementById('customModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        const modalCloseBtn = document.getElementById('modalCloseBtn');

         Create Goal Modal Elements
        const createGoalModal = document.getElementById('createGoalModal');
        const closeCreateGoalModalBtn = document.getElementById('closeCreateGoalModalBtn');
        const goalNameInput = document.getElementById('goalNameInput');
        const goalNameError = document.getElementById('goalNameError');
        const memberSelect = document.getElementById('memberSelect');
        const goalProjectSelect = document.getElementById('goalProjectSelect');  New project select for goals
        const forTypeSelect = document.getElementById('forTypeSelect');
        const forHoursInput = document.getElementById('forHoursInput');
        const forHoursError = document.getElementById('forHoursError');
        const forFrequencySelect = document.getElementById('forFrequencySelect');
        const untilDateInput = document.getElementById('untilDateInput');
        const noEndDateCheckbox = document.getElementById('noEndDateCheckbox');
        const untilDateError = document.getElementById('untilDateError');
        const cancelGoalBtn = document.getElementById('cancelGoalBtn');
        const createGoalBtnModal = document.getElementById('createGoalBtnModal');

         Create Project Modal Elements
        const createProjectModal = document.getElementById('createProjectModal');
        const closeCreateProjectModalBtn = document.getElementById('closeCreateProjectModalBtn');
        const projectNameInput = document.getElementById('projectNameInput');
        const projectNameError = document.getElementById('projectNameError');
        const cancelProjectBtn = document.getElementById('cancelProjectBtn');
        const createProjectBtnModal = document.getElementById('createProjectBtnModal');

         Advanced Report Modal Elements
        const advancedReportModal = document.getElementById('advancedReportModal');
        const closeReportModalBtn = document.getElementById('closeReportModalBtn');
        const reportProjectSelect = document.getElementById('reportProjectSelect');
        const reportStartDateInput = document.getElementById('reportStartDateInput');
        const reportEndDateInput = document.getElementById('reportEndDateInput');
        const reportDateError = document.getElementById('reportDateError');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const reportResultsList = document.getElementById('reportResultsList');
        const reportTotalDisplay = document.getElementById('reportTotalDisplay');

         Edit Time Entry Modal Elements
        const editTimeEntryModal = document.getElementById('editTimeEntryModal');
        const closeTimeEntryEditModalBtn = document.getElementById('closeTimeEntryEditModalBtn');
        const editTimeEntryId = document.getElementById('editTimeEntryId');
        const editTaskInput = document.getElementById('editTaskInput');
        const editTaskError = document.getElementById('editTaskError');
        const editTimeEntryProjectSelect = document.getElementById('editTimeEntryProjectSelect');
        const cancelTimeEntryEditBtn = document.getElementById('cancelTimeEntryEditBtn');
        const saveTimeEntryBtn = document.getElementById('saveTimeEntryBtn');

         Edit Goal Modal Elements
        const editGoalModal = document.getElementById('editGoalModal');
        const closeGoalEditModalBtn = document.getElementById('closeGoalEditModalBtn');
        const editGoalId = document.getElementById('editGoalId');
        const editGoalNameInput = document.getElementById('editGoalNameInput');
        const editGoalNameError = document.getElementById('editGoalNameError');
        const editGoalProjectSelect = document.getElementById('editGoalProjectSelect');
        const editForTypeSelect = document.getElementById('editForTypeSelect');
        const editForHoursInput = document.getElementById('editForHoursInput');
        const editForHoursError = document.getElementById('editForHoursError');
        const editForFrequencySelect = document.getElementById('editForFrequencySelect');
        const editUntilDateInput = document.getElementById('editUntilDateInput');
        const editNoEndDateCheckbox = document.getElementById('editNoEndDateCheckbox');
        const editUntilDateError = document.getElementById('editUntilDateError');
        const cancelGoalEditBtn = document.getElementById('cancelGoalEditBtn');
        const saveGoalEditBtn = document.getElementById('saveGoalEditBtn');

         Edit Project Modal Elements
        const editProjectModal = document.getElementById('editProjectModal');
        const closeProjectEditModalBtn = document.getElementById('closeProjectEditModalBtn');
        const editProjectId = document.getElementById('editProjectId');
        const editProjectNameInput = document.getElementById('editProjectNameInput');
        const editProjectNameError = document.getElementById('editProjectNameError');
        const editProjectDuplicateError = document.getElementById('editProjectDuplicateError');
        const cancelProjectEditBtn = document.getElementById('cancelProjectEditBtn');
        const saveProjectEditBtn = document.getElementById('saveProjectEditBtn');

         Export Data Modal Elements
        const exportDataModal = document.getElementById('exportDataModal');
        const closeExportModalBtn = document.getElementById('closeExportModalBtn');
        const exportDataTypeRadios = document.querySelectorAll('input[name=exportDataType]');
        const timeEntriesExportOptions = document.getElementById('timeEntriesExportOptions');
        const timeEntriesScopeRadios = document.querySelectorAll('input[name=timeEntriesScope]');
        const exportFormatRadios = document.querySelectorAll('input[name=exportFormat]');
        const cancelExportBtn = document.getElementById('cancelExportBtn');
        const exportDataConfirmBtn = document.getElementById('exportDataConfirmBtn');

         Toast Notification Container
        const toastContainer = document.getElementById('toastContainer');


        
          Displays a custom modal for alerts or confirmations.
          @param {string} message - The message to display in the modal.
          @param {'alert''confirm'} type - The type of modal ('alert' or 'confirm').
          @param {function(boolean)void} [onConfirm] - Callback function for 'confirm' type, receives truefalse.
          For 'alert' type, it's a simple close callback.
         
        function showCustomModal(message, type = 'alert', onConfirm = null) {
            modalMessage.textContent = message;
             Clear previous event listeners
            modalConfirmBtn.onclick = null;
            modalCancelBtn.onclick = null;
            modalCloseBtn.onclick = null;

            if (type === 'confirm') {
                modalConfirmBtn.classList.remove('hidden');
                modalCancelBtn.classList.remove('hidden');
                modalCloseBtn.classList.add('hidden');
                modalConfirmBtn.onclick = () = {
                    customModal.classList.add('hidden');
                    if (onConfirm) onConfirm(true);
                };
                modalCancelBtn.onclick = () = {
                    customModal.classList.add('hidden');
                    if (onConfirm) onConfirm(false);
                };
            } else {  'alert' type
                modalConfirmBtn.classList.add('hidden');
                modalCancelBtn.classList.add('hidden');
                modalCloseBtn.classList.remove('hidden');
                modalCloseBtn.onclick = () = {
                    customModal.classList.add('hidden');
                    if (onConfirm) onConfirm();  For alerts, onConfirm might be a simple callback
                };
            }
            customModal.classList.remove('hidden');
            customModal.classList.add('flex');  Ensure it's flex for centering
             Set focus to the first interactive element in the alert modal
            if (type === 'confirm') {
                modalConfirmBtn.focus();
            } else {
                modalCloseBtn.focus();
            }
        }

        
          Shows a temporary toast notification.
          @param {string} message - The message to display.
          @param {'success''error'} type - The type of notification.
          @param {number} duration - Duration in milliseconds.
         
        function showToast(message, type = 'success', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);

             Trigger reflow to enable transition
            void toast.offsetWidth;
            toast.classList.add('show');

            setTimeout(() = {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () = {
                    toast.remove();
                });
            }, duration);
        }

        
          Sets focus to the first focusable element inside a modal.
          @param {HTMLElement} modalElement - The modal DOM element.
         
        function setFocusToFirstElement(modalElement) {
            const focusableElements = modalElement.querySelectorAll(
                'button, [href], inputnot([type=hidden])not([disabled]), selectnot([disabled]), textareanot([disabled]), [tabindex]not([tabindex=-1])'
            );
            const firstFocusableElement = focusableElements[0];
            if (firstFocusableElement) {
                firstFocusableElement.focus();
            }
        }

        
          Hides an error message element and removes its invalid styling.
          @param {HTMLElement} errorElement - The error message paragraph element.
          @param {HTMLElement} inputElement - The associated inputselect element.
         
        function hideError(errorElement, inputElement) {
            errorElement.classList.add('hidden');
            inputElement.classList.remove('border-red-500');
            inputElement.classList.add('border-gray-600');
        }

        
          Shows an error message element and applies invalid styling.
          @param {HTMLElement} errorElement - The error message paragraph element.
          @param {HTMLElement} inputElement - The associated inputselect element.
          @param {string} message - The error message to display.
         
        function showError(errorElement, inputElement, message) {
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            inputElement.classList.add('border-red-500');
            inputElement.classList.remove('border-gray-600');
        }


         --- Local Storage Functions ---
        
          Saves the current time entries, goals, projects, and active tracking state to local storage.
         
        function saveToLocalStorage() {
            try {
                localStorage.setItem('timeTrackerEntries', JSON.stringify(timeEntries));
                localStorage.setItem('timeTrackerGoals', JSON.stringify(goals));
                localStorage.setItem('timeTrackerProjects', JSON.stringify(projects));  Save projects
                 Also save current tracking state if any
                if (currentTask) {
                    localStorage.setItem('currentTrackingState', JSON.stringify({
                        task currentTask.task,
                        projectId currentTask.projectId,  Save project ID
                        projectName currentTask.projectName,  Save project name
                        startTime startTime.toISOString(),
                        id currentTask.id
                    }));
                } else {
                    localStorage.removeItem('currentTrackingState');  Clear state if no task is running
                }
            } catch (e) {
                console.error(Error saving to local storage, e);
                showToast(Failed to save data. Local storage might be full or unavailable., 'error');
            }
        }

        
          Loads time entries, goals, projects, and active tracking state from local storage.
         
        function loadFromLocalStorage() {
            try {
                const storedEntries = localStorage.getItem('timeTrackerEntries');
                if (storedEntries) {
                    timeEntries = JSON.parse(storedEntries);
                }
                const storedGoals = localStorage.getItem('timeTrackerGoals');
                if (storedGoals) {
                    goals = JSON.parse(storedGoals);
                }
                const storedProjects = localStorage.getItem('timeTrackerProjects');  Load projects
                if (storedProjects) {
                    projects = JSON.parse(storedProjects);
                }

                const storedTrackingState = localStorage.getItem('currentTrackingState');
                if (storedTrackingState) {
                    const state = JSON.parse(storedTrackingState);
                    startTime = new Date(state.startTime);
                    currentTask = {
                        id state.id,
                        task state.task,
                        projectId state.projectId,
                        projectName state.projectName
                    };
                    startTimerDisplay();  Resume timer display
                    taskInput.value = state.task;
                    projectSelect.value = state.projectId  '';  Select the project
                    playPauseIcon.classList.remove('fa-play');
                    playPauseIcon.classList.add('fa-pause');
                    taskInput.disabled = true;  Disable input while tracking
                    projectSelect.disabled = true;  Disable project select while tracking
                }
            } catch (e) {
                console.error(Error loading from local storage, e);
                showToast(Failed to load data. Your saved data might be corrupted., 'error');
            }
        }

         --- Time Formatting and Calculations ---
        
          Formats a duration in milliseconds into HHMMSS string format.
          @param {number} ms - Duration in milliseconds.
          @returns {string} Formatted time string.
         
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms  1000);
            const hours = Math.floor(totalSeconds  3600);
            const minutes = Math.floor((totalSeconds % 3600)  60);
            const seconds = totalSeconds % 60;
            return [hours, minutes, seconds]
                .map(unit = String(unit).padStart(2, '0'))
                .join('');
        }

        
          Checks if two Date objects represent the same calendar day.
          @param {Date} d1 - First date.
          @param {Date} d2 - Second date.
          @returns {boolean} True if dates are on the same day, false otherwise.
         
        function isSameDay(d1, d2) {
            return d1.getFullYear() === d2.getFullYear() &&
                   d1.getMonth() === d2.getMonth() &&
                   d1.getDate() === d2.getDate();
        }

        
          Calculates the start of the week (Monday) for a given date.
          @param {Date} date - The date to find the start of the week for.
          @returns {Date} A new Date object representing the Monday of that week at 000000.
         
        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();  Sunday - Saturday  0 - 6
             Adjust to Monday (1) for consistent week start. If day is Sunday (0), subtract 6 days.
             Otherwise, subtract (day - 1) days.
            const diff = d.getDate() - day + (day === 0  -6  1);
            d.setDate(diff);
            d.setHours(0, 0, 0, 0);  Set to start of the day
            return d;
        }

        
          Checks if two Date objects fall within the same calendar week (Monday to Sunday).
          @param {Date} d1 - First date.
          @param {Date} d2 - Second date.
          @returns {boolean} True if dates are in the same week, false otherwise.
         
        function isSameWeek(d1, d2) {
            const startOfWeek1 = getStartOfWeek(d1);
            const startOfWeek2 = getStartOfWeek(d2);
            return isSameDay(startOfWeek1, startOfWeek2);
        }

        
          Calculates the start of the month for a given date.
          @param {Date} date - The date to find the start of the month for.
          @returns {Date} A new Date object representing the first day of that month at 000000.
         
        function getStartOfMonth(date) {
            const d = new Date(date);
            d.setDate(1);  Set to the first day of the month
            d.setHours(0, 0, 0, 0);  Set to start of the day
            return d;
        }

        
          Checks if two Date objects fall within the same calendar month.
          @param {Date} d1 - First date.
          @param {Date} d2 - Second date.
          @returns {boolean} True if dates are in the same month, false otherwise.
         
        function isSameMonth(d1, d2) {
            return d1.getFullYear() === d2.getFullYear() &&
                   d1.getMonth() === d2.getMonth();
        }

        
          Formats a Date object into a readable string (e.g., July 3, 2025).
          If the date is today, it returns Today.
          @param {Date} date - The date to format.
          @returns {string} Formatted date string.
         
        function formatDateForDisplay(date) {
            const today = new Date();
            if (isSameDay(date, today)) {
                return Today;
            }
            return date.toLocaleDateString('en-US', { year 'numeric', month 'long', day 'numeric' });
        }


         --- Render Functions ---
        
          Renders the time entries for the `currentDisplayedDate` in the task list.
          Sorts entries by most recent first.
         
        function renderEntries() {
             Filter entries for the currentDisplayedDate
            const entriesForDisplay = timeEntries.filter(entry = entry.startTime && isSameDay(new Date(entry.startTime), currentDisplayedDate));
            entriesForDisplay.sort((a, b) = new Date(b.startTime) - new Date(a.startTime));  Sort by most recent first

            taskList.innerHTML = '';  Clear existing entries
            if (entriesForDisplay.length === 0) {
                noEntriesMessage.style.display = 'block';
            } else {
                noEntriesMessage.style.display = 'none';
                entriesForDisplay.forEach(entry = {
                    const start = new Date(entry.startTime);
                    const end = entry.endTime  new Date(entry.endTime)  null;
                    const duration = entry.durationMs;

                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'task-entry';
                    entryDiv.innerHTML = `
                        div class=task-entry-details
                            div class=task-entry-description${entry.task}div
                            div class=text-xs text-gray-500${entry.projectName  `Project ${entry.projectName}`  'No Project'}div
                            div class=task-entry-times
                                ${start.toLocaleTimeString([], { hour '2-digit', minute '2-digit' })}
                                ${end  ` - ${end.toLocaleTimeString([], { hour '2-digit', minute '2-digit' })}`  ''}
                            div
                        div
                        div class=flex items-center gap-2
                            div class=task-entry-duration${formatTime(duration)}div
                            button class=text-gray-400 hovertext-blue-400 onclick=openEditTimeEntryModal('${entry.id}') aria-label=Edit Time Entry
                                i class=fas fa-pencil-alti
                            button
                            button class=text-red-400 hovertext-red-600 onclick=deleteEntry('${entry.id}') aria-label=Delete Time Entry
                                i class=fas fa-trash-alti
                            button
                        div
                    `;
                    taskList.appendChild(entryDiv);
                });
            }
             Update the displayed date in the task list header
            currentViewDateDisplay.textContent = formatDateForDisplay(currentDisplayedDate);
            currentViewDateDisplayHeader.textContent = formatDateForDisplay(currentDisplayedDate);  Update header
            updateTotals();  Update global totals (always for todaythis week)
        }

        
          Calculates and updates the total time tracked for the actual current day and this week.
         
        function updateTotals() {
            const today = new Date();
            let totalTodayMs = 0;
            let totalWeekMs = 0;

            timeEntries.forEach(entry = {
                 Ensure entry has a valid startTime and durationMs before calculation
                if (entry.startTime && typeof entry.durationMs === 'number') {
                    const entryStartTime = new Date(entry.startTime);
                    if (isSameDay(entryStartTime, today)) {
                        totalTodayMs += entry.durationMs;
                    }
                    if (isSameWeek(entryStartTime, today)) {
                        totalWeekMs += entry.durationMs;
                    }
                }
            });

            todayTotalDisplay.textContent = formatTime(totalTodayMs);
            weekTotalDisplay.textContent = formatTime(totalWeekMs);
        }

        
          Renders the list of goals, including their progress circles.
         
        function renderGoals() {
            goalsList.innerHTML = '';  Clear existing goals
            if (goals.length === 0) {
                noGoalsMessage.style.display = 'block';
            } else {
                noGoalsMessage.style.display = 'none';
                goals.forEach(goal = {
                     Check if the goal period needs to be reset
                    const now = new Date();
                    const lastReset = new Date(goal.lastResetDate);
                    let shouldReset = false;

                    if (goal.frequency === 'day' && !isSameDay(now, lastReset)) {
                        shouldReset = true;
                    } else if (goal.frequency === 'week' && !isSameWeek(now, lastReset)) {
                        shouldReset = true;
                    } else if (goal.frequency === 'month' && !isSameMonth(now, lastReset)) {
                        shouldReset = true;
                    }

                    if (shouldReset) {
                        goal.currentMs = 0;
                        goal.lastResetDate = now.toISOString();
                        saveToLocalStorage();  Save updated goal state immediately
                    }

                     Check for end date
                    if (goal.endDate && now  new Date(goal.endDate)) {
                         Goal has ended, could mark as completed or remove
                         For now, let's just indicate it's ended.
                    }

                    const progressPercentage = Math.min(100, (goal.currentMs  goal.targetMs)  100  0);
                    const goalDiv = document.createElement('div');
                    goalDiv.className = 'goal-item';
                    goalDiv.innerHTML = `
                        div class=goal-progress-circle style=--progress ${progressPercentage}%
                            span${Math.round(progressPercentage)}%span
                        div
                        div class=flex-grow
                            div class=font-semibold${goal.name}div
                            div class=text-sm text-gray-400
                                ${goal.projectName  `Project ${goal.projectName}br`  ''}
                                ${formatTime(goal.currentMs)}  ${formatTime(goal.targetMs)} ${goal.frequency}
                                ${goal.endDate  ` (Until ${new Date(goal.endDate).toLocaleDateString()})`  ''}
                                ${goal.endDate && now  new Date(goal.endDate)  ' span class=text-red-400(Ended)span'  ''}
                            div
                        div
                        div class=flex items-center gap-2
                            button class=text-gray-400 hovertext-blue-400 onclick=openEditGoalModal('${goal.id}') aria-label=Edit Goal
                                i class=fas fa-pencil-alti
                            button
                            button class=text-red-400 hovertext-red-600 onclick=deleteGoal('${goal.id}') aria-label=Delete Goal
                                i class=fas fa-trash-alti
                            button
                        div
                    `;
                    goalsList.appendChild(goalDiv);
                });
            }
        }

        
          Renders the list of projects, including their total tracked time.
         
        function renderProjects() {
            projectsList.innerHTML = '';  Clear existing projects
            if (projects.length === 0) {
                noProjectsMessage.style.display = 'block';
            } else {
                noProjectsMessage.style.display = 'none';
                projects.forEach(project = {
                     Calculate total time for this project
                    const projectTotalMs = timeEntries.reduce((sum, entry) = {
                        return entry.projectId === project.id  sum + entry.durationMs  sum;
                    }, 0);

                    const projectDiv = document.createElement('div');
                    projectDiv.className = 'project-item';
                    projectDiv.innerHTML = `
                        div class=flex-grow
                            div class=font-semibold${project.name}div
                            div class=text-sm text-gray-400Total ${formatTime(projectTotalMs)}div
                        div
                        div class=flex items-center gap-2
                            button class=text-gray-400 hovertext-blue-400 onclick=openEditProjectModal('${project.id}') aria-label=Edit Project
                                i class=fas fa-pencil-alti
                            button
                            button class=text-red-400 hovertext-red-600 onclick=deleteProject('${project.id}') aria-label=Delete Project
                                i class=fas fa-trash-alti
                            button
                        div
                    `;
                    projectsList.appendChild(projectDiv);
                });
            }
            populateProjectSelects();  Update project dropdowns after rendering projects
        }

        
          Populates the project dropdowns in the top bar, goal modal, and report modal.
         
        function populateProjectSelects() {
             Clear existing options, keep the default Select Project
            projectSelect.innerHTML = 'option value=Select Project (Optional)option';
            goalProjectSelect.innerHTML = 'option value=Select Project (Optional)option';
            reportProjectSelect.innerHTML = 'option value=All Projectsoption';  For reports
            editTimeEntryProjectSelect.innerHTML = 'option value=Select Project (Optional)option';  For edit time entry modal
            editGoalProjectSelect.innerHTML = 'option value=Select Project (Optional)option';  For edit goal modal


            projects.forEach(project = {
                const option1 = document.createElement('option');
                option1.value = project.id;
                option1.textContent = project.name;
                projectSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = project.id;
                option2.textContent = project.name;
                goalProjectSelect.appendChild(option2);

                const option3 = document.createElement('option');
                option3.value = project.id;
                option3.textContent = project.name;
                reportProjectSelect.appendChild(option3);

                const option4 = document.createElement('option');
                option4.value = project.id;
                option4.textContent = project.name;
                editTimeEntryProjectSelect.appendChild(option4);

                const option5 = document.createElement('option');
                option5.value = project.id;
                option5.textContent = project.name;
                editGoalProjectSelect.appendChild(option5);
            });

             Re-select the project if one was active when loading from local storage
            if (currentTask && currentTask.projectId) {
                projectSelect.value = currentTask.projectId;
            }
        }

         --- Time Tracking Logic ---
        
          Starts or resumes the visual timer display.
         
        function startTimerDisplay() {
            if (timerInterval) clearInterval(timerInterval);  Clear any existing interval
            timerInterval = setInterval(() = {
                if (startTime) {
                    const elapsedMs = new Date().getTime() - startTime.getTime();
                    timerDisplay.textContent = formatTime(elapsedMs);
                }
            }, 1000);
        }

        playPauseButton.addEventListener('click', () = {
            if (!currentTask) {  Start a new task if no task is currently being tracked
                const selectedProjectId = projectSelect.value  null;  Make project optional
                const selectedProjectName = selectedProjectId  projectSelect.options[projectSelect.selectedIndex].text  null;
                const taskDescription = taskInput.value.trim();

                if (!taskDescription) {
                    showToast(Please enter a task description before starting., 'error');
                    return;
                }

                startTime = new Date();
                const newId = Date.now().toString();  Simple unique ID for the new entry
                currentTask = {
                    id newId,
                    task taskDescription,
                    projectId selectedProjectId,
                    projectName selectedProjectName,
                    startTime startTime.toISOString(),  Store as ISO string for consistent date parsing
                    endTime null,  Null until stopped
                    durationMs 0  Initial duration
                };
                timeEntries.push(currentTask);  Add to the array of entries
                playPauseIcon.classList.remove('fa-play');
                playPauseIcon.classList.add('fa-pause');
                taskInput.disabled = true;  Disable input while tracking
                projectSelect.disabled = true;  Disable project select while tracking
                startTimerDisplay();  Start updating the timer display
                showToast(Timer started!, 'success');
            } else {  PauseStop current task
                clearInterval(timerInterval);  Stop the visual timer
                timerInterval = null;
                playPauseIcon.classList.remove('fa-pause');
                playPauseIcon.classList.add('fa-play');
                taskInput.disabled = false;  Re-enable input
                projectSelect.disabled = false;  Re-enable project select

                const endTime = new Date();
                const elapsedMs = endTime.getTime() - startTime.getTime();

                 Find and update the current task in the timeEntries array
                const index = timeEntries.findIndex(entry = entry.id === currentTask.id);
                if (index !== -1) {
                    timeEntries[index].endTime = endTime.toISOString();
                    timeEntries[index].durationMs = elapsedMs;
                }

                 Update goal progress based on the just-completed task
                updateGoalProgress(currentTask.projectId, elapsedMs);  Pass project ID

                 Reset current task state for the next tracking session
                currentTask = null;
                startTime = null;
                timerDisplay.textContent = '00000';  Reset timer display
                taskInput.value = '';  Clear task input
                projectSelect.value = '';  Reset project select
                showToast(Timer stopped!, 'success');
            }
            saveToLocalStorage();  Save all data after any change
            renderEntries();  Re-render entries to reflect changes
            renderGoals();  Re-render goals to reflect progress
            renderProjects();  Re-render projects to update totals
        });

         --- Date Navigation Logic ---
        prevDateBtn.addEventListener('click', () = {
            currentDisplayedDate.setDate(currentDisplayedDate.getDate() - 1);
            renderEntries();
        });

        nextDateBtn.addEventListener('click', () = {
            currentDisplayedDate.setDate(currentDisplayedDate.getDate() + 1);
            renderEntries();
        });

        goToTodayBtn.addEventListener('click', () = {
            currentDisplayedDate = new Date();  Reset to today
            renderEntries();
        });

         --- Create Goal Modal Logic ---
        openCreateGoalModalBtn.addEventListener('click', () = {
             Reset modal fields before opening
            goalNameInput.value = '';
            hideError(goalNameError, goalNameInput);
            forHoursInput.value = '';
            hideError(forHoursError, forHoursInput);
            forFrequencySelect.value = 'day';
            untilDateInput.value = '';
            hideError(untilDateError, untilDateInput);
            noEndDateCheckbox.checked = false;
            untilDateInput.disabled = false;  Ensure date input is enabled by default
            goalProjectSelect.value = '';  Reset project selection in goal modal

            createGoalModal.classList.remove('hidden');
            createGoalModal.classList.add('flex');  Show modal
            setFocusToFirstElement(createGoalModal);
        });

        closeCreateGoalModalBtn.addEventListener('click', () = {
            createGoalModal.classList.add('hidden');  Hide modal
            createGoalModal.classList.remove('flex');
        });

        cancelGoalBtn.addEventListener('click', () = {
            createGoalModal.classList.add('hidden');  Hide modal
            createGoalModal.classList.remove('flex');
        });

        noEndDateCheckbox.addEventListener('change', () = {
            untilDateInput.disabled = noEndDateCheckbox.checked;
            if (noEndDateCheckbox.checked) {
                untilDateInput.value = '';  Clear date if no end date is selected
                hideError(untilDateError, untilDateInput);  Hide error if checkbox is checked
            }
        });

        createGoalBtnModal.addEventListener('click', () = {
            const goalName = goalNameInput.value.trim();
            const targetHours = parseFloat(forHoursInput.value);
            const frequency = forFrequencySelect.value;
            const endDate = noEndDateCheckbox.checked  null  untilDateInput.value;
            const selectedGoalProjectId = goalProjectSelect.value  null;  Make project optional for goals
            const selectedGoalProjectName = selectedGoalProjectId  goalProjectSelect.options[goalProjectSelect.selectedIndex].text  null;

            let isValid = true;

            if (!goalName) {
                showError(goalNameError, goalNameInput, Goal name is required.);
                isValid = false;
            } else {
                hideError(goalNameError, goalNameInput);
            }

            if (isNaN(targetHours)  targetHours = 0) {
                showError(forHoursError, forHoursInput, Enter a positive number for hours.);
                isValid = false;
            } else {
                hideError(forHoursError, forHoursInput);
            }

            if (!noEndDateCheckbox.checked && !endDate) {
                showError(untilDateError, untilDateInput, Select an end date or check 'No end date'.);
                isValid = false;
            } else {
                hideError(untilDateError, untilDateInput);
            }

            if (!isValid) {
                return;
            }

            const newGoal = {
                id Date.now().toString(),
                name goalName,
                targetMs targetHours  3600  1000,  Convert hours to milliseconds
                frequency frequency,
                endDate endDate,  Store as ISO string 'YYYY-MM-DD'
                currentMs 0,
                lastResetDate new Date().toISOString(),  Initialize with current date
                projectId selectedGoalProjectId,  Store project ID or null
                projectName selectedGoalProjectName  Store project name or null
            };
            goals.push(newGoal);
            saveToLocalStorage();
            renderGoals();
            createGoalModal.classList.add('hidden');  Hide modal
            createGoalModal.classList.remove('flex');
            showToast(Goal created successfully!, 'success');
        });


        
          Updates the progress of relevant goals based on a completed task.
          @param {string  null} completedProjectId - The ID of the project the task belonged to (can be null).
          @param {number} durationMs - The duration of the completed task in milliseconds.
         
        function updateGoalProgress(completedProjectId, durationMs) {
            goals.forEach(goal = {
                 Update goal if it's not linked to a specific project (null projectId)
                 OR if it is linked to a project AND that project matches the completedProjectId
                if ((!goal.projectId && completedProjectId === null)  (goal.projectId && goal.projectId === completedProjectId)) {
                    const now = new Date();
                    const lastReset = new Date(goal.lastResetDate);
                    let shouldReset = false;

                    if (goal.frequency === 'day' && !isSameDay(now, lastReset)) {
                        shouldReset = true;
                    } else if (goal.frequency === 'week' && !isSameWeek(now, lastReset)) {
                        shouldReset = true;
                    } else if (goal.frequency === 'month' && !isSameMonth(now, lastReset)) {
                        shouldReset = true;
                    }

                    if (shouldReset) {
                        goal.currentMs = 0;
                        goal.lastResetDate = now.toISOString();
                    }

                     Add duration if goal has not ended
                    if (!goal.endDate  now = new Date(goal.endDate)) {
                        goal.currentMs += durationMs;
                    }
                }
            });
            saveToLocalStorage();  Save updated goals progress
        }

         --- Create Project Modal Logic ---
        openCreateProjectModalBtn.addEventListener('click', () = {
            projectNameInput.value = '';  Clear input
            hideError(projectNameError, projectNameInput);
            createProjectModal.classList.remove('hidden');
            createProjectModal.classList.add('flex');
            setFocusToFirstElement(createProjectModal);
        });

        closeCreateProjectModalBtn.addEventListener('click', () = {
            createProjectModal.classList.add('hidden');
            createProjectModal.classList.remove('flex');
        });

        cancelProjectBtn.addEventListener('click', () = {
            createProjectModal.classList.add('hidden');
            createProjectModal.classList.remove('flex');
        });

        createProjectBtnModal.addEventListener('click', () = {
            const projectName = projectNameInput.value.trim();
            let isValid = true;

            if (!projectName) {
                showError(projectNameError, projectNameInput, Project name is required.);
                isValid = false;
            } else {
                hideError(projectNameError, projectNameInput);
            }

             Check for duplicate project names
            if (projects.some(p = p.name.toLowerCase() === projectName.toLowerCase())) {
                showError(projectNameError, projectNameInput, A project with this name already exists.);
                isValid = false;
            }

            if (!isValid) {
                return;
            }

            const newProject = {
                id Date.now().toString(),  Simple unique ID
                name projectName
            };
            projects.push(newProject);
            saveToLocalStorage();
            renderProjects();  Re-render projects list and dropdowns
            createProjectModal.classList.add('hidden');
            createProjectModal.classList.remove('flex');
            showToast(Project created successfully!, 'success');
        });

         --- Advanced Report Modal Logic ---
        openAdvancedReportModalBtn.addEventListener('click', () = {
             Reset report modal fields before opening
            reportProjectSelect.value = '';
            reportStartDateInput.value = '';
            reportEndDateInput.value = '';
            hideError(reportDateError, reportStartDateInput);  Clear potential date errors
            hideError(reportDateError, reportEndDateInput);
            reportResultsList.innerHTML = 'p class=text-gray-400 text-center py-4Generate a report to see results here.p';
            reportTotalDisplay.textContent = '00000';

             Populate project select in report modal
            populateProjectSelects();

            advancedReportModal.classList.remove('hidden');
            advancedReportModal.classList.add('flex');
            setFocusToFirstElement(advancedReportModal);
        });

        closeReportModalBtn.addEventListener('click', () = {
            advancedReportModal.classList.add('hidden');
            advancedReportModal.classList.remove('flex');
        });

        generateReportBtn.addEventListener('click', () = {
            const filterProjectId = reportProjectSelect.value  null;
            const startDateStr = reportStartDateInput.value;
            const endDateStr = reportEndDateInput.value;

            let startDate = startDateStr  new Date(startDateStr)  null;
            let endDate = endDateStr  new Date(endDateStr)  null;

            let isValid = true;
            hideError(reportDateError, reportStartDateInput);
            hideError(reportDateError, reportEndDateInput);


             Adjust end date to include the whole day
            if (endDate) {
                endDate.setHours(23, 59, 59, 999);
            }

             Validate dates
            if (startDate && endDate && startDate  endDate) {
                showError(reportDateError, reportStartDateInput, Start date cannot be after end date.);
                showError(reportDateError, reportEndDateInput, );  Apply red border to end date too
                isValid = false;
            }

            if (!isValid) {
                return;
            }

            let filteredEntries = timeEntries.filter(entry = {
                const entryDate = new Date(entry.startTime);
                const matchesProject = !filterProjectId  entry.projectId === filterProjectId;
                const matchesStartDate = !startDate  entryDate = startDate;
                const matchesEndDate = !endDate  entryDate = endDate;
                return matchesProject && matchesStartDate && matchesEndDate;
            });

            filteredEntries.sort((a, b) = new Date(b.startTime) - new Date(a.startTime));  Sort by most recent first

            reportResultsList.innerHTML = '';
            let totalReportDurationMs = 0;

            if (filteredEntries.length === 0) {
                reportResultsList.innerHTML = 'p class=text-gray-400 text-center py-4No entries found for the selected criteria.p';
            } else {
                filteredEntries.forEach(entry = {
                    totalReportDurationMs += entry.durationMs;
                    const start = new Date(entry.startTime);
                    const end = entry.endTime  new Date(entry.endTime)  null;
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'report-entry';
                    entryDiv.innerHTML = `
                        div class=report-entry-header
                            span${entry.task}span
                            span${formatTime(entry.durationMs)}span
                        div
                        div class=report-entry-details
                            ${entry.projectName  `Project ${entry.projectName}  `  ''}
                            ${start.toLocaleDateString()} ${start.toLocaleTimeString([], { hour '2-digit', minute '2-digit' })}
                            ${end  ` - ${end.toLocaleTimeString([], { hour '2-digit', minute '2-digit' })}`  ''}
                        div
                    `;
                    reportResultsList.appendChild(entryDiv);
                });
            }
            reportTotalDisplay.textContent = formatTime(totalReportDurationMs);
            showToast(Report generated!, 'success');
        });


         --- Edit Time Entry Modal Logic ---
        window.openEditTimeEntryModal = function(id) {
            const entry = timeEntries.find(e = e.id === id);
            if (entry) {
                editTimeEntryId.value = entry.id;
                editTaskInput.value = entry.task;
                hideError(editTaskError, editTaskInput);  Clear previous error
                 Populate project select and set current value
                populateProjectSelects();  Ensure dropdown is up-to-date
                editTimeEntryProjectSelect.value = entry.projectId  '';

                editTimeEntryModal.classList.remove('hidden');
                editTimeEntryModal.classList.add('flex');
                setFocusToFirstElement(editTimeEntryModal);
            }
        };

        closeTimeEntryEditModalBtn.addEventListener('click', () = {
            editTimeEntryModal.classList.add('hidden');
            editTimeEntryModal.classList.remove('flex');
        });

        cancelTimeEntryEditBtn.addEventListener('click', () = {
            editTimeEntryModal.classList.add('hidden');
            editTimeEntryModal.classList.remove('flex');
        });

        saveTimeEntryBtn.addEventListener('click', () = {
            const id = editTimeEntryId.value;
            const updatedTask = editTaskInput.value.trim();
            const updatedProjectId = editTimeEntryProjectSelect.value  null;
            const updatedProjectName = updatedProjectId  editTimeEntryProjectSelect.options[editTimeEntryProjectSelect.selectedIndex].text  null;

            let isValid = true;
            if (!updatedTask) {
                showError(editTaskError, editTaskInput, Task description cannot be empty.);
                isValid = false;
            } else {
                hideError(editTaskError, editTaskInput);
            }

            if (!isValid) {
                return;
            }

            const index = timeEntries.findIndex(e = e.id === id);
            if (index !== -1) {
                timeEntries[index].task = updatedTask;
                timeEntries[index].projectId = updatedProjectId;
                timeEntries[index].projectName = updatedProjectName;
                saveToLocalStorage();
                renderEntries();  Re-render to show updated entry
                renderProjects();  Re-render projects to ensure totals are correct
                editTimeEntryModal.classList.add('hidden');
                editTimeEntryModal.classList.remove('flex');
                showToast(Time entry updated successfully!, 'success');
            }
        });

         --- Edit Goal Modal Logic ---
        window.openEditGoalModal = function(id) {
            const goal = goals.find(g = g.id === id);
            if (goal) {
                editGoalId.value = goal.id;
                editGoalNameInput.value = goal.name;
                hideError(editGoalNameError, editGoalNameInput);  Clear previous error
                populateProjectSelects();  Ensure project dropdown is up-to-date
                editGoalProjectSelect.value = goal.projectId  '';
                editForHoursInput.value = (goal.targetMs  3600  1000).toFixed(1);  Convert ms to hours
                hideError(editForHoursError, editForHoursInput);  Clear previous error
                editForFrequencySelect.value = goal.frequency;
                editUntilDateInput.value = goal.endDate  '';
                hideError(editUntilDateError, editUntilDateInput);  Clear previous error
                editNoEndDateCheckbox.checked = !goal.endDate;
                editUntilDateInput.disabled = !goal.endDate;

                editGoalModal.classList.remove('hidden');
                editGoalModal.classList.add('flex');
                setFocusToFirstElement(editGoalModal);
            }
        };

        closeGoalEditModalBtn.addEventListener('click', () = {
            editGoalModal.classList.add('hidden');
            editGoalModal.classList.remove('flex');
        });

        cancelGoalEditBtn.addEventListener('click', () = {
            editGoalModal.classList.add('hidden');
            editGoalModal.classList.remove('flex');
        });

        editNoEndDateCheckbox.addEventListener('change', () = {
            editUntilDateInput.disabled = editNoEndDateCheckbox.checked;
            if (editNoEndDateCheckbox.checked) {
                editUntilDateInput.value = '';
                hideError(editUntilDateError, editUntilDateInput);
            }
        });

        saveGoalEditBtn.addEventListener('click', () = {
            const id = editGoalId.value;
            const updatedName = editGoalNameInput.value.trim();
            const updatedTargetHours = parseFloat(editForHoursInput.value);
            const updatedFrequency = editForFrequencySelect.value;
            const updatedEndDate = editNoEndDateCheckbox.checked  null  editUntilDateInput.value;
            const updatedProjectId = editGoalProjectSelect.value  null;
            const updatedProjectName = updatedProjectId  editGoalProjectSelect.options[editGoalProjectSelect.selectedIndex].text  null;

            let isValid = true;

            if (!updatedName) {
                showError(editGoalNameError, editGoalNameInput, Goal name is required.);
                isValid = false;
            } else {
                hideError(editGoalNameError, editGoalNameInput);
            }

            if (isNaN(updatedTargetHours)  updatedTargetHours = 0) {
                showError(editForHoursError, editForHoursInput, Enter a positive number for hours.);
                isValid = false;
            } else {
                hideError(editForHoursError, editForHoursInput);
            }

            if (!editNoEndDateCheckbox.checked && !updatedEndDate) {
                showError(editUntilDateError, editUntilDateInput, Select an end date or check 'No end date'.);
                isValid = false;
            } else {
                hideError(editUntilDateError, editUntilDateInput);
            }

            if (!isValid) {
                return;
            }

            const index = goals.findIndex(g = g.id === id);
            if (index !== -1) {
                goals[index].name = updatedName;
                goals[index].targetMs = updatedTargetHours  3600  1000;
                goals[index].frequency = updatedFrequency;
                goals[index].endDate = updatedEndDate;
                goals[index].projectId = updatedProjectId;
                goals[index].projectName = updatedProjectName;
                saveToLocalStorage();
                renderGoals();  Re-render to show updated goal
                editGoalModal.classList.add('hidden');
                editGoalModal.classList.remove('flex');
                showToast(Goal updated successfully!, 'success');
            }
        });

         --- Edit Project Modal Logic ---
        window.openEditProjectModal = function(id) {
            const project = projects.find(p = p.id === id);
            if (project) {
                editProjectId.value = project.id;
                editProjectNameInput.value = project.name;
                hideError(editProjectNameError, editProjectNameInput);  Clear previous error
                hideError(editProjectDuplicateError, editProjectNameInput);  Clear duplicate error
                editProjectModal.classList.remove('hidden');
                editProjectModal.classList.add('flex');
                setFocusToFirstElement(editProjectModal);
            }
        };

        closeProjectEditModalBtn.addEventListener('click', () = {
            editProjectModal.classList.add('hidden');
            editProjectModal.classList.remove('flex');
        });

        cancelProjectEditBtn.addEventListener('click', () = {
            editProjectModal.classList.add('hidden');
            editProjectModal.classList.remove('flex');
        });

        saveProjectEditBtn.addEventListener('click', () = {
            const id = editProjectId.value;
            const updatedName = editProjectNameInput.value.trim();
            let isValid = true;

            if (!updatedName) {
                showError(editProjectNameError, editProjectNameInput, Project name is required.);
                isValid = false;
            } else {
                hideError(editProjectNameError, editProjectNameInput);
            }

             Check for duplicate project names (excluding the current project being edited)
            if (projects.some(p = p.name.toLowerCase() === updatedName.toLowerCase() && p.id !== id)) {
                showError(editProjectDuplicateError, editProjectNameInput, A project with this name already exists.);
                isValid = false;
            } else {
                hideError(editProjectDuplicateError, editProjectNameInput);
            }

            if (!isValid) {
                return;
            }

            const index = projects.findIndex(p = p.id === id);
            if (index !== -1) {
                projects[index].name = updatedName;
                 Also update project names in time entries and goals
                timeEntries.forEach(entry = {
                    if (entry.projectId === id) {
                        entry.projectName = updatedName;
                    }
                });
                goals.forEach(goal = {
                    if (goal.projectId === id) {
                        goal.projectName = updatedName;
                    }
                });

                saveToLocalStorage();
                renderProjects();  Re-render projects list and dropdowns
                renderEntries();  Re-render entries to update project names
                renderGoals();  Re-render goals to update project names
                editProjectModal.classList.add('hidden');
                editProjectModal.classList.remove('flex');
                showToast(Project updated successfully!, 'success');
            }
        });


         --- Export Data Modal Logic ---
        openExportDataModalBtn.addEventListener('click', () = {
             Reset modal state
            document.querySelector('input[name=exportDataType][value=timeEntries]').checked = true;
            document.querySelector('input[name=timeEntriesScope][value=all]').checked = true;
            document.querySelector('input[name=exportFormat][value=csv]').checked = true;
            timeEntriesExportOptions.style.display = 'block';  Show time entries options by default

            exportDataModal.classList.remove('hidden');
            exportDataModal.classList.add('flex');
            setFocusToFirstElement(exportDataModal);
        });

        closeExportModalBtn.addEventListener('click', () = {
            exportDataModal.classList.add('hidden');
            exportDataModal.classList.remove('flex');
        });

        cancelExportBtn.addEventListener('click', () = {
            exportDataModal.classList.add('hidden');
            exportDataModal.classList.remove('flex');
        });

         Toggle time entries export options visibility based on data type selection
        exportDataTypeRadios.forEach(radio = {
            radio.addEventListener('change', () = {
                if (radio.value === 'timeEntries') {
                    timeEntriesExportOptions.style.display = 'block';
                } else {
                    timeEntriesExportOptions.style.display = 'none';
                }
            });
        });

        exportDataConfirmBtn.addEventListener('click', () = {
            const selectedDataType = document.querySelector('input[name=exportDataType]checked').value;
            const selectedFormat = document.querySelector('input[name=exportFormat]checked').value;
            let dataToExport = [];
            let filename = '';

            if (selectedDataType === 'timeEntries') {
                const scope = document.querySelector('input[name=timeEntriesScope]checked').value;
                if (scope === 'all') {
                    dataToExport = timeEntries;
                    filename = 'time_entries_all';
                } else {  'filtered'
                    const filterProjectId = reportProjectSelect.value  null;  Use report modal's project filter
                    const startDateStr = reportStartDateInput.value;  Use report modal's start date
                    const endDateStr = reportEndDateInput.value;      Use report modal's end date

                    let startDate = startDateStr  new Date(startDateStr)  null;
                    let endDate = endDateStr  new Date(endDateStr)  null;

                    if (endDate) {
                        endDate.setHours(23, 59, 59, 999);
                    }

                     Re-validate dates in case user changed them in report modal without generating report
                    if (startDate && endDate && startDate  endDate) {
                        showToast(Report start date cannot be after end date. Please adjust in Advanced Reports., 'error');
                        return;
                    }

                    dataToExport = timeEntries.filter(entry = {
                        const entryDate = new Date(entry.startTime);
                        const matchesProject = !filterProjectId  entry.projectId === filterProjectId;
                        const matchesStartDate = !startDate  entryDate = startDate;
                        const matchesEndDate = !endDate  entryDate = endDate;
                        return matchesProject && matchesStartDate && matchesEndDate;
                    });
                    filename = 'time_entries_filtered';
                }
            } else if (selectedDataType === 'goals') {
                dataToExport = goals;
                filename = 'goals';
            } else if (selectedDataType === 'projects') {
                dataToExport = projects;
                filename = 'projects';
            }

            if (selectedFormat === 'csv') {
                exportToCsv(dataToExport, filename);
            } else {  json
                exportToJson(dataToExport, filename);
            }

            exportDataModal.classList.add('hidden');
            exportDataModal.classList.remove('flex');
            showToast(Data exported successfully!, 'success');
        });

        
          Converts an array of objects to CSV format and triggers download.
          @param {ArrayObject} data - The array of objects to export.
          @param {string} filename - The desired filename (without extension).
         
        function exportToCsv(data, filename) {
            if (data.length === 0) {
                showToast(No data to export., 'error');
                return;
            }

            const replacer = (key, value) = value === null  ''  value;  Handle null values
            const header = Object.keys(data[0]);
            let csv = data.map(row = header.map(fieldName = JSON.stringify(row[fieldName], replacer)).join(','));
            csv.unshift(header.join(','));  Add header column
            csv = csv.join('rn');

            const blob = new Blob([csv], { type 'textcsv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {  Feature detection
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `${filename}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                showToast(Your browser does not support downloading files directly. Please copy the data manually., 'error');
            }
        }

        
          Converts an array of objects to JSON format and triggers download.
          @param {ArrayObject} data - The array of objects to export.
          @param {string} filename - The desired filename (without extension).
         
        function exportToJson(data, filename) {
            if (data.length === 0) {
                showToast(No data to export., 'error');
                return;
            }
            const json = JSON.stringify(data, null, 2);  Pretty print JSON

            const blob = new Blob([json], { type 'applicationjson;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `${filename}.json`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                showToast(Your browser does not support downloading files directly. Please copy the data manually., 'error');
            }
        }


         --- Delete Functions ---
        
          Deletes a time entry from the list and local storage.
          @param {string} id - The ID of the time entry to delete.
         
        window.deleteEntry = function(id) {
            showCustomModal(Are you sure you want to delete this time entry, 'confirm', (confirmed) = {
                if (confirmed) {
                    timeEntries = timeEntries.filter(entry = entry.id !== id);  Filter out the deleted entry
                    saveToLocalStorage();  Save changes
                    renderEntries();  Re-render the list
                    renderGoals();  Re-render goals as totals might change
                    renderProjects();  Re-render projects to update totals
                    showToast(Time entry deleted., 'success');
                }
            });
        };

        
          Deletes a goal from the list and local storage.
          @param {string} id - The ID of the goal to delete.
         
        window.deleteGoal = function(id) {
            showCustomModal(Are you sure you want to delete this goal, 'confirm', (confirmed) = {
                if (confirmed) {
                    goals = goals.filter(goal = goal.id !== id);  Filter out the deleted goal
                    saveToLocalStorage();  Save changes
                    renderGoals();  Re-render the goals list
                    showToast(Goal deleted., 'success');
                }
            });
        };

        
          Deletes a project from the list and local storage.
          Also removes any time entries or goals associated with this project.
          @param {string} id - The ID of the project to delete.
         
        window.deleteProject = function(id) {
            showCustomModal(Deleting a project will also delete all associated time entries and goals. Are you sure, 'confirm', (confirmed) = {
                if (confirmed) {
                    projects = projects.filter(project = project.id !== id);
                     Also delete associated time entries
                    timeEntries = timeEntries.filter(entry = entry.projectId !== id);
                     Also delete associated goals
                    goals = goals.filter(goal = goal.projectId !== id);

                    saveToLocalStorage();
                    renderProjects();
                    renderEntries();
                    renderGoals();
                    showToast(Project and associated data deleted., 'success');
                }
            });
        };

         --- Initial Load ---
        window.onload = () = {
            loadFromLocalStorage();  Load data when the page loads
            renderProjects();  Render projects first to populate dropdowns
            renderEntries();  Render initial time entries for currentDisplayedDate
            renderGoals();  Render initial goals
             If a task was being tracked before refresh, ensure the timer display is running
            if (currentTask) {
                startTimerDisplay();
            }
        };
    script
body
html
